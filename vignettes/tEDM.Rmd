---
title: "Temporal Empirical Dynamic Modeling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tEDM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



## 1. Introduction to the `tEDM` package

The `tEDM` package provides a suite of tools for exploring and quantifying causality in time series using Empirical Dynamic Modeling (EDM). It implements four fundamental EDM-based causal discovery methods:

- [**Convergent Cross Mapping (CCM)**][1]

- [**Partial Cross Mapping (PCM)**][2]

- [**Cross Mapping Cardinality (CMC)**][3] 

- [**Multispatial Convergent Cross Mapping (MultispatialCCM)**][4]

These methods enable researchers to:

- **Identify** potential causal interactions without assuming a predefined model structure.

- **Distinguish** between direct causation and indirect (mediated or confounded) influences.

- **Reconstruct** underlying causal dynamics from replicated univariate time series observed across multiple spatial units.

## 2. Example data in the `tEDM` package

### Hong Kong Air Pollution and Cardiovascular Admissions

A daily time series dataset(from 1995-3 to 1997-11) for Hong Kong that includes cardiovascular hospital admissions and major air pollutant concentrations.

**File**: `cvd.csv`

**Columns**:

| Column | Description                                                 |
| ------ | ----------------------------------------------------------- |
| `cvd`  | Daily number of cardiovascular-related hospital admissions. |
| `rsp`  | Respirable suspended particulates (μg/m³).                  |
| `no2`  | Nitrogen dioxide concentration (μg/m³).                     |
| `so2`  | Sulfur dioxide concentration (μg/m³).                       |
| `o3`   | Ozone concentration (μg/m³).                                |

**Source**: Data adapted from [PCM article][2].

---

### US County-Level Carbon Emissions Dataset

A panel dataset covering U.S. county-level temperature and carbon emissions across time.

**File**: `carbon.csv.gz`

**Columns**:

| Column   | Description                                                              |
| -------- | ------------------------------------------------------------------------ |
| `year`   | Observation year (1981–2017).                                            |
| `fips`   | County FIPS code (5-digit Federal Information Processing Standard code). |
| `tem`    | Mean annual temperature (in Kelvin).                                     |
| `carbon` | Total carbon emissions per year (in kilograms of CO₂).                   |

**Source**: Data adapted from [FsATE article][5].

---

### COVID-19 Infection Counts in Japan

A spatio-temporal dataset capturing the number of confirmed COVID-19 infections across Japan’s 47 prefectures over time.

**File**: `covid.csv`

**Structure**:

* Each **column** represents one of the 47 Japanese prefectures (e.g., `Tokyo`, `Osaka`, `Hokkaido`).
* Each **row** corresponds to a time step (daily).

**Source**: Data adapted from [CMC article][3].

## 3. Case studies of the `tEDM` package

Install the stable version:

```r
install.packages("tEDM", dep = TRUE)
```

or dev version:

```r
install.packages("tEDM",
                 repos = c("https://stscl.r-universe.dev",
                           "https://cloud.r-project.org"),
                 dep = TRUE)
```

### Air Pollution and Cardiovascular Health in Hong Kong

Employing CCM, CMC and PCM to investigate the causal relationships between various air pollutants and cardiovascular diseases:


``` r
library(tEDM)

cvd = readr::read_csv(system.file("case/cvd.csv",package = "tEDM"))
## Rows: 1032 Columns: 5
## ── Column specification ─────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (5): cvd, rsp, no2, so2, o3
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
head(cvd)
## # A tibble: 6 × 5
##     cvd   rsp   no2   so2    o3
##   <dbl> <dbl> <dbl> <dbl> <dbl>
## 1   214  73.7  74.5  19.1 17.4 
## 2   203  77.6  80.9  18.8 39.4 
## 3   202  64.8  67.1  13.8 56.4 
## 4   182  68.8  74.7  30.8  5.6 
## 5   181  49.4  62.3  23.1  3.6 
## 6   129  67.4  63.6  17.4  6.73
```


``` r
cvd_long = cvd |> 
  tibble::rowid_to_column("id") |> 
  tidyr::pivot_longer(cols = -id,
                      names_to = "variable", values_to = "value")

fig1 = ggplot2::ggplot(cvd_long, ggplot2::aes(x = id, y = value, color = variable)) +
  ggplot2::geom_line(linewidth = 1) +
  ggplot2::labs(x = "Days (from 1995-3 to 1997-11)", y = "Concentrations or \nNO. of CVD admissions", color = "") +
  ggplot2::theme_bw() +
  ggplot2::theme(legend.direction = "horizontal",
                 legend.position = "inside",
                 legend.justification = c("center","top"),
                 legend.background = ggplot2::element_rect(fill = "transparent", color = NA))
fig1
```

![**Figure 1**. Time series of air pollutants and confirmed CVD cases in Hong Kong from March 1995 to November 1997.](../man/figures/edm/fig1-1.png)

Determining optimal embedding dimension:


``` r
tEDM::fnn(cvd,"cvd",E = 2:50,eps = stats::sd(cvd$cvd))
##       E:1       E:2       E:3       E:4       E:5       E:6       E:7       E:8 
## 0.4827586 0.5611765 0.3894850 0.3004292 0.2682403 0.2564378 0.2607296 0.2671674 
##       E:9      E:10      E:11      E:12      E:13      E:14      E:15      E:16 
## 0.2639485 0.2607296 0.2521459 0.2682403 0.2467811 0.2457082 0.2392704 0.2242489 
##      E:17      E:18      E:19      E:20      E:21      E:22      E:23      E:24 
## 0.2306867 0.2371245 0.2435622 0.2414163 0.2317597 0.2242489 0.2199571 0.2296137 
##      E:25      E:26      E:27      E:28      E:29      E:30      E:31      E:32 
## 0.2253219 0.2242489 0.2285408 0.2435622 0.2339056 0.2306867 0.2242489 0.2360515 
##      E:33      E:34      E:35      E:36      E:37      E:38      E:39      E:40 
## 0.2510730 0.2532189 0.2553648 0.2532189 0.2500000 0.2521459 0.2564378 0.2457082 
##      E:41      E:42      E:43      E:44      E:45      E:46      E:47      E:48 
## 0.2478541 0.2414163 0.2435622 0.2478541 0.2489270 0.2585837 0.2671674 0.2553648 
##      E:49 
## 0.2585837
```

Starting at $E = 5$, the FNN ratio stabilizes near 0.2; thus, embedding dimension E and neighbor number k are chosen from 5 onward for subsequent self-prediction parameter selection.


``` r
tEDM::simplex(cvd,"cvd","cvd",E = 5:25,k = 6:35)
## The suggested E and k for variable cvd is 5 and 6
tEDM::simplex(cvd,"rsp","rsp",E = 5:25,k = 6:35)
## The suggested E and k for variable rsp is 5 and 6
tEDM::simplex(cvd,"no2","no2",E = 5:25,k = 6:35)
## The suggested E and k for variable no2 is 5 and 8
tEDM::simplex(cvd,"so2","so2",E = 5:25,k = 6:35)
## The suggested E and k for variable so2 is 5 and 15
tEDM::simplex(cvd,"o3","o3",E = 5:25,k = 6:35)
## The suggested E and k for variable o3 is 5 and 6
```

We first use CCM to explore the causal influences of air pollutants on the incidence of cardiovascular diseases.


``` r
rsp_cvd = tEDM::ccm(cvd,"rsp","cvd",libsizes = seq(32,1032,100),E = 5,k = 6,progressbar = FALSE)
rsp_cvd
##    libsizes   rsp->cvd   cvd->rsp
## 1        32 0.04319516 0.01319450
## 2       132 0.04437840 0.04042972
## 3       232 0.05755968 0.04856251
## 4       332 0.05213455 0.05497566
## 5       432 0.04204529 0.05345864
## 6       532 0.03869321 0.05163371
## 7       632 0.03449846 0.05149252
## 8       732 0.02813186 0.05075322
## 9       832 0.02364578 0.05075094
## 10      932 0.02226927 0.05080212
## 11     1027 0.07212221 0.05626339
no2_cvd = tEDM::ccm(cvd,"no2","cvd",libsizes = seq(32,1032,100),E = 5,k = c(8,6),progressbar = FALSE)
no2_cvd
##    libsizes   no2->cvd   cvd->no2
## 1        32 0.09597753 0.04864942
## 2       132 0.12416134 0.09638212
## 3       232 0.15621628 0.11924223
## 4       332 0.16302570 0.12659628
## 5       432 0.15722930 0.12724020
## 6       532 0.15592151 0.12779650
## 7       632 0.15271207 0.12670729
## 8       732 0.14752161 0.12305037
## 9       832 0.14525414 0.12052819
## 10      932 0.14519559 0.11924900
## 11     1027 0.23186797 0.17037681
so2_cvd = tEDM::ccm(cvd,"so2","cvd",libsizes = seq(32,1032,100),E = 5,k = c(15,6),progressbar = FALSE)
so2_cvd
##    libsizes    so2->cvd   cvd->so2
## 1        32 0.038665119 0.03405003
## 2       132 0.023943075 0.06258078
## 3       232 0.020748020 0.07086180
## 4       332 0.019672824 0.07066856
## 5       432 0.017233107 0.07339913
## 6       532 0.016922496 0.07205969
## 7       632 0.014945947 0.07428336
## 8       732 0.011701558 0.07877438
## 9       832 0.009729901 0.08091936
## 10      932 0.009048317 0.08116150
## 11     1027 0.011257499 0.07416282
o3_cvd = tEDM::ccm(cvd,"o3","cvd",libsizes = seq(32,1032,100),E = 5,k = 6,progressbar = FALSE)
o3_cvd
##    libsizes       o3->cvd    cvd->o3
## 1        32 -0.0021382170 0.02675574
## 2       132 -0.0028994401 0.03818003
## 3       232  0.0015246470 0.04784981
## 4       332  0.0047085847 0.04764828
## 5       432  0.0030374107 0.04542627
## 6       532  0.0020648753 0.04110124
## 7       632  0.0009115659 0.03699687
## 8       732 -0.0017126973 0.03108036
## 9       832 -0.0011312952 0.02697292
## 10      932  0.0004006101 0.02451813
## 11     1027  0.0480365415 0.06844222
```


``` r
figa = plot(rsp_cvd,ylimits = c(-0.01,0.1),ybreaks = c(0,0.05,0.1))
figb = plot(no2_cvd,ylimits = c(0.03,0.25),ybreaks = seq(0.05,0.25,0.05))
figc = plot(so2_cvd,ylimits = c(-0.01,0.1),ybreaks = c(0,0.05,0.1))
figd = plot(o3_cvd,ylimits = c(-0.01,0.1),ybreaks = c(0,0.05,0.1))

fig2 = cowplot::plot_grid(figa, figb, figc, figd, ncol = 2,
                         label_fontfamily = 'serif',
                         labels = letters[1:4])
fig2
```

![**Figure 2**. Cross-mapping results between different air pollutants and cardiovascular diseases.](../man/figures/edm/fig2-1.png)

The results shown in Figure2 indicate the presence of the following causal influences:

- rsp → cvd  
- no₂ → cvd  
- cvd → no₂  
- cvd → o₃

However, based on practical experience, the relationship between CVDs and spatial pollution is likely reflective rather than causal. Therefore, we further employ CCM to examine the causal paths of cvd → no₂ and cvd → o₃.


``` r
g1 = tEDM::cmc(cvd,"o3","cvd",E = 5,k = 100,progressbar = FALSE)
g1
##   neighbors o3->cvd cvd->o3
## 1       100  0.2344  0.5589
g1$xmap
##   neighbors x_xmap_y_mean x_xmap_y_sig x_xmap_y_upper x_xmap_y_lower
## 1       100        0.5589     0.188823      0.6467507      0.4710493
##   y_xmap_x_mean y_xmap_x_sig y_xmap_x_upper y_xmap_x_lower
## 1        0.2344 2.138197e-12      0.3085003      0.1602997

g2 = tEDM::cmc(cvd,"no2","cvd",E = 5,k = 100,progressbar = FALSE)
g2
##   neighbors no2->cvd cvd->no2
## 1       100   0.4833   0.5363
g2$xmap
##   neighbors x_xmap_y_mean x_xmap_y_sig x_xmap_y_upper x_xmap_y_lower
## 1       100        0.5363    0.4205595      0.6246315      0.4479685
##   y_xmap_x_mean y_xmap_x_sig y_xmap_x_upper y_xmap_x_lower
## 1        0.4833    0.7186329      0.5741482      0.3924518
```

The causal paths **cvd → no₂** and **cvd → o₃** are not statistically significant in the CMC analysis results, allowing us to rule out these two directions. Therefore, we conclude that only **rsp** and **no₂** exhibit causal influences on CVDs.

We further aim to explore the potential causal interactions among different air pollutants. However, due to space constraints in this vignette, we limit our analysis to a single test case — specifically, examining whether **NO₂** exerts a causal influence on **Respirable Suspended Particulates (rsp)**.


``` r
no2_rsp = tEDM::pcm(cvd,"no2","rsp","cvd",libsizes = seq(32,1032,100),E = 5,k = c(8,6,6),progressbar = FALSE)
no2_rsp
## -------------------------------------- 
## ***partial cross mapping prediction*** 
## -------------------------------------- 
##    libsizes  no2->rsp  rsp->no2
## 1        32 0.5718384 0.5872235
## 2       132 0.6926588 0.6891724
## 3       232 0.7129181 0.6999073
## 4       332 0.7251034 0.7065649
## 5       432 0.7292544 0.7132728
## 6       532 0.7305393 0.7175689
## 7       632 0.7308904 0.7208970
## 8       732 0.7322006 0.7239768
## 9       832 0.7335073 0.7282566
## 10      932 0.7338654 0.7295781
## 11     1027 0.7362657 0.7246647
## 
## ------------------------------ 
## ***cross mapping prediction*** 
## ------------------------------ 
##    libsizes  no2->rsp  rsp->no2
## 1        32 0.5891342 0.6095253
## 2       132 0.7085988 0.7137024
## 3       232 0.7235291 0.7327955
## 4       332 0.7325251 0.7409321
## 5       432 0.7368667 0.7435845
## 6       532 0.7382566 0.7454804
## 7       632 0.7389185 0.7473104
## 8       732 0.7397101 0.7479086
## 9       832 0.7399319 0.7481982
## 10      932 0.7399475 0.7481772
## 11     1027 0.7623938 0.7574991

figa = plot(no2_rsp,partial = FALSE,ylimits = c(0.5,0.85),ybreaks = seq(0.5,0.85,0.05))
figb = plot(no2_rsp,ylimits = c(0.5,0.85),ybreaks = seq(0.5,0.85,0.05))

fig3 = cowplot::plot_grid(figa, figb, ncol = 2,
                          label_fontfamily = 'serif',
                          labels = letters[1:2])
fig3
```

![**Figure 3**. Cross-mapping results between no₂ and respirable suspended particulates. **a**. CCM results without accounting for other variables. **b**. PCM results controlling for the influence of CVDs.](../man/figures/edm/fig3-1.png)

The CCM and PCM results between **NO₂** and **respirable suspended particulates** show minimal differences and are both statistically significant, indicating the presence of a causal relationship between the two. Therefore, the final set of confirmed causal pathways is as follows (exclude those with no causal influence on CVDs):

![**Figure 4**. Causal interactions between air pollutants and cardiovascular diseases in Hong Kong.](../man/figures/edm/hk-cvd.png)

### US County Carbon Emissions and Temperature Dynamics

To examine whether a causal relationship exists between annual mean temperature and total annual CO₂ emissions, we implement the CMC method across counties.


``` r
library(tEDM)

carbon = readr::read_csv(system.file("case/carbon.csv.gz",package = "tEDM"))
## Rows: 113627 Columns: 4
## ── Column specification ─────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (4): year, fips, tem, carbon
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
head(carbon)
## # A tibble: 6 × 4
##    year  fips   tem     carbon
##   <dbl> <dbl> <dbl>      <dbl>
## 1  1981  1001  17.4 192607687.
## 2  1982  1001  18.4 187149414.
## 3  1983  1001  16.9 191584445.
## 4  1984  1001  17.8 199157579.
## 5  1985  1001  17.9 205207564.
## 6  1986  1001  18.5 218446030.

carbon_list = dplyr::group_split(carbon, by = fips)
length(carbon_list)
## [1] 3071
```

Using the 100th county as an example, we determine the appropriate embedding dimension by applying the FNN method.


``` r
tEDM::fnn(carbon_list[[100]],"carbon",E = 2:10,eps = stats::sd(carbon_list[[100]]$carbon))
##        E:1        E:2        E:3        E:4        E:5        E:6        E:7 
## 0.58823529 0.23529412 0.23529412 0.17647059 0.05882353 0.00000000 0.00000000 
##        E:8        E:9 
## 0.00000000 0.00000000
```

When E equals 6, the FNN ratio begins to drop to zero; therefore, we select $E = 6$ as the embedding dimension for the CMC analysis.


``` r
res = carbon_list |> 
  purrr::map_dfr(\(.x) {
    g = tEDM::cmc(.x,"tem","carbon",E = 6,k = 20,progressbar = FALSE)
    return(g$xmap)
  })
head(res)
##   neighbors x_xmap_y_mean x_xmap_y_sig x_xmap_y_upper x_xmap_y_lower
## 1        20       0.23000 7.559829e-04      0.3871031     0.07289694
## 2        20       0.15250 5.155608e-08      0.2775652     0.02743478
## 3        20       0.15125 3.546400e-08      0.2752574     0.02724258
## 4        20       0.14125 1.237298e-08      0.2647264     0.01777360
## 5        20       0.14625 2.766598e-08      0.2710497     0.02145029
## 6        20       0.13625 9.223181e-09      0.2603593     0.01214072
##   y_xmap_x_mean y_xmap_x_sig y_xmap_x_upper y_xmap_x_lower
## 1       0.03875 2.661759e-41      0.1059107              0
## 2       0.04250 3.673257e-37      0.1128988              0
## 3       0.04375 2.129338e-31      0.1204663              0
## 4       0.04375 2.129338e-31      0.1204663              0
## 5       0.04500 1.570561e-32      0.1200890              0
## 6       0.03750 2.118657e-39      0.1065211              0

res_carbon = res |> 
  dplyr::select(neighbors,
                carbon_tem = x_xmap_y_mean,
                tem_carbon = y_xmap_x_mean) |> 
  tidyr::pivot_longer(c(carbon_tem, tem_carbon), 
                      names_to = "variable", values_to = "value")
head(res_carbon)
## # A tibble: 6 × 3
##   neighbors variable    value
##       <dbl> <chr>       <dbl>
## 1        20 carbon_tem 0.23  
## 2        20 tem_carbon 0.0388
## 3        20 carbon_tem 0.152 
## 4        20 tem_carbon 0.0425
## 5        20 carbon_tem 0.151 
## 6        20 tem_carbon 0.0438
```


``` r
fig_case2 = ggplot2::ggplot(res_carbon, 
                            ggplot2::aes(x = variable, y = value, fill = variable)) +
  ggplot2::geom_boxplot() +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "", y = "Causal Strength") +
  ggplot2::scale_x_discrete(labels = c("carbon_tem" = "carbon → tem",
                                       "tem_carbon" = "tem → carbon")) +
  ggplot2::theme(legend.position = "none")
fig_case2
```

![**Figure 5**. Causal strength scores between annual mean temperature and total annual CO₂ emissions across US counties, with embedding dimension E set to 6 and number of neighbors set to 20.](../man/figures/edm/fig_case2-1.png)

### COVID-19 Spread Across Japanese Prefectures

We examine the COVID-19 transmission between Tokyo and other prefectures by applying CCM to identify the underlying causal dynamics of the epidemic spread


``` r
library(tEDM)

covid = readr::read_csv(system.file("case/covid.csv",package = "tEDM"))
## Rows: 334 Columns: 47
## ── Column specification ─────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (47): Hokkaido, Aomori, Iwate, Miyagi, Akita, Yamagata, Fukushima, Ibarak...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
head(covid)
## # A tibble: 6 × 47
##   Hokkaido Aomori Iwate Miyagi Akita Yamagata Fukushima Ibaraki Tochigi Gunma
##      <dbl>  <dbl> <dbl>  <dbl> <dbl>    <dbl>     <dbl>   <dbl>   <dbl> <dbl>
## 1        0      0     0      0     0        0         0       0       0     0
## 2        0      0     0      0     0        0         0       0       0     0
## 3        0      0     0      0     0        0         0       0       0     0
## 4        0      0     0      0     0        0         0       0       0     0
## 5        0      0     0      0     0        0         0       0       0     0
## 6        0      0     0      0     0        0         0       0       0     0
## # ℹ 37 more variables: Saitama <dbl>, Chiba <dbl>, Tokyo <dbl>, Kanagawa <dbl>,
## #   Niigata <dbl>, Toyama <dbl>, Ishikawa <dbl>, Fukui <dbl>, Yamanashi <dbl>,
## #   Nagano <dbl>, Gifu <dbl>, Shizuoka <dbl>, Aichi <dbl>, Mie <dbl>,
## #   Shiga <dbl>, Kyoto <dbl>, Osaka <dbl>, Hyogo <dbl>, Nara <dbl>,
## #   Wakayama <dbl>, Tottori <dbl>, Shimane <dbl>, Okayama <dbl>,
## #   Hiroshima <dbl>, Yamaguchi <dbl>, Tokushima <dbl>, Kagawa <dbl>,
## #   Ehime <dbl>, Kochi <dbl>, Fukuoka <dbl>, Saga <dbl>, Nagasaki <dbl>, …
```

The data are first differenced:


``` r
covid = covid |> 
  dplyr::mutate(dplyr::across(dplyr::everything(),
                              \(.x) c(NA,diff(.x))))
```

Using Tokyo's COVID-19 infection data to test the optimal embedding dimension.


``` r
tEDM::fnn(covid,"Tokyo",E = 2:30,eps = stats::sd(covid$Tokyo))
##        E:1        E:2        E:3        E:4        E:5        E:6        E:7 
## 0.82432432 0.43333333 0.14598540 0.07664234 0.06934307 0.05474453 0.03284672 
##        E:8        E:9       E:10       E:11       E:12       E:13       E:14 
## 0.01459854 0.01459854 0.00729927 0.00000000 0.00000000 0.00000000 0.00000000 
##       E:15       E:16       E:17       E:18       E:19       E:20       E:21 
## 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 
##       E:22       E:23       E:24       E:25       E:26       E:27       E:28 
## 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 
##       E:29 
## 0.00000000
```

Since the FNN ratio begins to approach zero when E equals 11, embedding dimensions from 11 onward are evaluated, and the pair of E and k yielding the highest self-prediction accuracy is selected for the CCM procedure.


``` r
tEDM::simplex(covid,"Tokyo","Tokyo",E = 11:50,k = 15:60)
## The suggested E and k for variable Tokyo is 11 and 16
```


``` r
res = names(covid)[-match("Tokyo",names(covid))] |> 
  purrr::map_dfr(\(.l) {
    g = tEDM::ccm(covid,"Tokyo",.l,E = 11,k = 16,tau = 0,progressbar = FALSE)
    res = dplyr::mutate(g$xmap,x = "Tokyo",y = .l)
    return(res)
  })
head(res)
##   libsizes x_xmap_y_mean x_xmap_y_sig x_xmap_y_upper x_xmap_y_lower
## 1      323     0.7194347 9.527435e-53     0.66230393      0.7682476
## 2      323     0.2356305 1.879218e-05     0.12984019      0.3361165
## 3      323     0.5676352 6.057533e-29     0.48878419      0.6372872
## 4      323     0.6004427 5.029307e-33     0.52576481      0.6659358
## 5      323     0.1912783 5.475818e-04     0.08390065      0.2942648
## 6      323     0.7341790 6.346860e-56     0.67949098      0.7807538
##   y_xmap_x_mean y_xmap_x_sig y_xmap_x_upper y_xmap_x_lower     x        y
## 1     0.7813231 1.089493e-67      0.7348512      0.8204928 Tokyo Hokkaido
## 2     0.5286610 1.185012e-24      0.4452176      0.6030015 Tokyo   Aomori
## 3     0.7795907 3.314325e-67      0.7328059      0.8190392 Tokyo    Iwate
## 4     0.7972467 2.392638e-72      0.7536909      0.8338302 Tokyo   Miyagi
## 5     0.4590275 3.079043e-18      0.3683504      0.5410534 Tokyo    Akita
## 6     0.5694476 3.704062e-29      0.4908197      0.6388748 Tokyo Yamagata

df1 = res |>
    dplyr::select(x,y,y_xmap_x_mean,y_xmap_x_sig)|>
    purrr::set_names(c("cause","effect","cs","sig"))
df2 = res |>
    dplyr::select(y,x,x_xmap_y_mean,x_xmap_y_sig) |>
    purrr::set_names(c("cause","effect","cs","sig"))
res_covid = dplyr::bind_rows(df1,df2)|> 
  dplyr::filter(cause == "Tokyo") |> 
  dplyr::arrange(dplyr::desc(cs))
head(res_covid,5)
##   cause   effect        cs           sig
## 1 Tokyo Kanagawa 0.9337641 2.698678e-145
## 2 Tokyo    Osaka 0.9277809 1.762531e-139
## 3 Tokyo  Saitama 0.9247632 9.810852e-137
## 4 Tokyo    Chiba 0.9174220 1.653727e-130
## 5 Tokyo    Aichi 0.9153784 7.065131e-129
```

Our CCM analysis reproduced the same results as the [original CMC study][3], with the top five prefectures most affected by Tokyo’s COVID-19 spread matching those previously identified.

![**Figure 6**. The five prefectures most affected by Tokyo, Kanagawa, Osaka, Saitama, Chiba, and Aichi, are located on the map. Red, blue and green dashed rings represent Tokyo, Nagoya and Osaka metropolitan areas, respectively. (*Figure adapted from [CMC  article][3].*)](../man/figures/edm/jp-covid19.png)

## Reference

Sugihara, G., May, R., Ye, H., Hsieh, C., Deyle, E., Fogarty, M., Munch, S., 2012. Detecting Causality in Complex Ecosystems. Science 338, 496–500. [https://doi.org/10.1126/science.1227079][1].

Leng, S., Ma, H., Kurths, J., Lai, Y.-C., Lin, W., Aihara, K., Chen, L., 2020. Partial cross mapping eliminates indirect causal influences. Nature Communications 11. [https://doi.org/10.1038/s41467-020-16238-0][2].

Tao, P., Wang, Q., Shi, J., Hao, X., Liu, X., Min, B., Zhang, Y., Li, C., Cui, H., Chen, L., 2023. Detecting dynamical causality by intersection cardinal concavity. Fundamental Research. [https://doi.org/10.1016/j.fmre.2023.01.007][3].

Clark, A.T., Ye, H., Isbell, F., Deyle, E.R., Cowles, J., Tilman, G.D., Sugihara, G., 2015. Spatial convergent cross mapping to detect causal relationships from short time series. Ecology 96, 1174–1181. [https://doi.org/10.1890/14-1479.1][4].

Gan, T., Succar, R., Macrì, S., Marín, M.R., Porfiri, M., 2025. Causal discovery from city data, where urban scaling meets information theory. Cities 162, 105980. [https://doi.org/10.1016/j.cities.2025.105980][5].

&nbsp; 

[1]: https://doi.org/10.1126/science.1227079
[2]: https://doi.org/10.1038/s41467-020-16238-0
[3]: https://doi.org/10.1016/j.fmre.2023.01.007
[4]: https://doi.org/10.1890/14-1479.1
[5]: https://doi.org/10.1016/j.cities.2025.105980
